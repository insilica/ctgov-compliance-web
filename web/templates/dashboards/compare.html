{% extends 'layout.html' %} {% block title %}Compare Organization Compliance - CTGov Compliance{% endblock %} {% block
content %}
<div class="grid-container-full">
    <div class="grid-row grid-gap">
        <div class="grid-col-3 padding-1">
            <div class="grid-row grid-gap margin-bottom-2">
                <div class="grid-col-fill text-left">
                    <h2 class="usa-heading margin-y-1 font-family-sans">Organization Statistics</h2>
                </div>
            </div>
            <!-- Summary Statistics -->
            <div class="grid-row grid-gap margin-bottom-2">
                <div class="grid-col-12">
                    <div class="grid-row">
                        <div class="grid-col-10">
                            <p class="font-sans-lg margin-0">Total Organizations</p>
                        </div>
                        <div class="grid-col-2 display-flex flex-justify-end">
                            <p class="font-sans-lg margin-0">{{ org_compliance|length }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid-row grid-gap margin-bottom-2">
                <div class="grid-col-12">
                    <div class="grid-row">
                        <div class="grid-col-10">
                            <p class="font-sans-lg margin-0">Average Compliance Rate</p>
                        </div>
                        <div class="grid-col-2 display-flex flex-justify-end">
                            <p class="font-sans-lg margin-0">
                                {% set ns = namespace(total_rate=0) %}
                                {% for org in org_compliance %}
                                {% set compliance = (org.on_time_count / org.total_trials * 100) if org.total_trials > 0
                                else 0 %}
                                {% set ns.total_rate = ns.total_rate + compliance %}
                                {% endfor %}
                                {{ (ns.total_rate / (org_compliance|length) if org_compliance|length > 0 else
                                0)|round|int }}%
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid-row grid-gap margin-bottom-2">
                <div class="grid-col-12">
                    <div class="grid-row">
                        <div class="grid-col-10">
                            <p class="font-sans-lg margin-0">Total Trials</p>
                        </div>
                        <div class="grid-col-2 display-flex flex-justify-end">
                            <p class="font-sans-lg margin-0">
                                {% set ns_trials = namespace(total_trials=0) %}
                                {% for org in org_compliance %}
                                {% set ns_trials.total_trials = ns_trials.total_trials + org.total_trials %}
                                {% endfor %}
                                {{ ns_trials.total_trials }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Options -->
            <div class="grid-row grid-gap margin-bottom-2">
                <div class="grid-col-12">
                    <h2 class="usa-heading margin-y-1 font-family-sans">Filter Organizations</h2>
                    <form class="usa-form margin-0 padding-0  width-full maxw-full" method="GET">
                        <div class="grid-row grid-gap">
                            <div class="grid-col-12">
                                <label class="usa-label margin-y-1" for="min-compliance">Compliance Rate
                                    (%)</label>
                                <div class="grid-row">
                                    <div class="grid-col-5">
                                        <input class="usa-input" placeholder="Min" type="number" id="min-compliance"
                                            name="min_compliance" min="0" max="100"
                                            value="{{ request.args.get('min_compliance', '') }}">
                                    </div>
                                    <div class="grid-col-2 display-flex flex-align-center flex-justify-center">
                                        &mdash;
                                    </div>
                                    <div class="grid-col-5">
                                        <input class="usa-input" placeholder="Max" type="number" id="min-compliance"
                                            name="min_compliance" min="0" max="100"
                                            value="{{ request.args.get('min_compliance', '') }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid-row grid-gap">
                            <div class="grid-col-12">
                                <label class="usa-label margin-y-1" for="min-trials">Number of Trials</label>
                                <div class="grid-row">
                                    <div class="grid-col-5">
                                        <input class="usa-input" placeholder="Min" type="number" id="min-trials"
                                            name="min_trials" min="0" value="{{ request.args.get('min_trials', '') }}">
                                    </div>
                                    <div class="grid-col-2 display-flex flex-align-center flex-justify-center">
                                        &mdash;
                                    </div>
                                    <div class="grid-col-5">
                                        <input class="usa-input" placeholder="Max" type="number" id="max-trials"
                                            name="max_trials" min="0" value="{{ request.args.get('max_trials', '') }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid-row grid-gap">
                            <div class="grid-col-12 display-flex flex-justify-end">
                                <button class="usa-button margin-0" type="submit">Apply Filters</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="grid-col-9 padding-1">
            <!-- Per-page selector and table -->
            <div class="grid-row grid-gap margin-bottom-2">
                <div class="grid-col-8 text-left">
                    <h1 class="usa-heading margin-y-1">Compare Organization Compliance Rates</h1>
                    {% if pagination %}
                    <span class="usa-hint">Showing {{ pagination.end_index }} of {{ pagination.total_entries }}
                        entries</span>
                    {% endif %}
                </div>
                <div class="grid-col-4 display-flex flex-row flex-justify-center flex-align-center">
                    <form method="GET" class="display-inline">
                        {% for key, value in request.args.items() %}
                        {% if key != 'per_page' and key != 'page' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                        {% endfor %}
                        <div class="grid-row">
                            <div class="grid-col-12">
                                <label class="usa-label margin-0" for="entries-per-page">Rows per page:</label>
                            </div>
                        </div>
                        <div class="grid-row">
                            <div class="grid-col-12">
                                <select class="usa-select margin-0" id="entries-per-page" name="per_page"
                                    onchange="this.form.submit()">
                                    <option value="10" {% if per_page==10 %}selected{% endif %}>10</option>
                                    <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                                    <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                                    <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                                </select>
                                <input type="hidden" name="page" value="1">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% include 'tables/organization_table.html' with context %}
            {% if pagination.total_pages > 1 %}
            <div class="grid-row margin-top-2">
                <div class="grid-col-12">
                    <nav class="usa-pagination" aria-label="Pagination">
                        <ul class="usa-pagination__list">
                            {% if pagination.has_prev %}
                            <li class="usa-pagination__item usa-pagination__arrow">
                                {% set prev_args = request.args.copy() %} {% do prev_args.pop('page', None) %} {% do
                                prev_args.update({'page': pagination.prev_page}) %}
                                <a href="{{ url_for(request.endpoint, **prev_args) }}"
                                    class="usa-pagination__link usa-pagination__previous-page">
                                    <span class="usa-pagination__link-text">Previous</span>
                                </a>
                            </li>
                            {% endif %}
                            {% for p in pagination.iter_pages() %}
                            {% if p %}
                            {% set page_args = request.args.copy() %} {% do page_args.pop('page', None) %} {% do
                            page_args.update({'page': p}) %}
                            <li class="usa-pagination__item {% if p == pagination.page %}usa-current{% endif %}">
                                <a href="{{ url_for(request.endpoint, **page_args) }}" class="usa-pagination__button">{{
                                    p }}</a>
                            </li>
                            {% else %}
                            <li class="usa-pagination__item usa-pagination__overflow">
                                <span>...</span>
                            </li>
                            {% endif %}
                            {% endfor %}
                            {% if pagination.has_next %}
                            <li class="usa-pagination__item usa-pagination__arrow">
                                {% set next_args = request.args.copy() %} {% do next_args.pop('page', None) %} {% do
                                next_args.update({'page': pagination.next_page}) %}
                                <a href="{{ url_for(request.endpoint, **next_args) }}"
                                    class="usa-pagination__link usa-pagination__next-page">
                                    <span class="usa-pagination__link-text">Next</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}