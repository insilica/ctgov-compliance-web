{% extends "layout.html" %}
{% block title %}Reporting{% endblock title %}
{% block content %}
<div class="grid-container-widescreen width-full margin-x-auto padding-y-4">
    <nav class="usa-breadcrumb margin-bottom-3" aria-label="Breadcrumb">
        <ol class="usa-breadcrumb__list">
            <li class="usa-breadcrumb__list-item">
                <a href="{{ url_for('routes.index') }}" class="usa-breadcrumb__link">Home</a>
            </li>
            <li class="usa-breadcrumb__list-item usa-current" aria-current="page">
                Reporting
            </li>
        </ol>
    </nav>

    <div class="grid-row grid-gap">
        <!-- Sidebar -->
        <div class="desktop:grid-col-3">
            <form method="get"
                class="usa-form usa-form--large bg-base-lightest padding-3 radius-md shadow-2 margin-bottom-3">
                <fieldset class="usa-fieldset margin-0">
                    <legend class="usa-label font-sans-lg">Date range</legend>
                    <div class="grid-row grid-gap">
                        <div class="grid-col-12">
                            <label class="usa-label" for="start_date">Start date</label>
                            <input class="usa-input" type="date" id="start_date" name="start_date"
                                value="{{ start_date }}">
                        </div>
                        <div class="grid-col-12">
                            <label class="usa-label" for="end_date">End date</label>
                            <input class="usa-input" type="date" id="end_date" name="end_date" value="{{ end_date }}">
                        </div>
                    </div>
                </fieldset>
                <div class="display-flex flex-justify-between flex-align-center margin-top-2">
                    <button class="usa-button" type="submit">
                        Update range
                    </button>
                    <a class="usa-button usa-button--outline" href="{{ url_for('routes.reporting_dashboard') }}">
                        Reset
                    </a>
                </div>
            </form>
        </div>

        <!-- Main Content -->
        <div class="desktop:grid-col-9">
            <section class="reporting-kpi-strip usa-card shadow-2 margin-bottom-3" aria-label="Key performance indicators">
                <div class="reporting-kpi-card">
                    <p class="kpi-label text-uppercase text-semibold" id="totalTrialsLabel">Total Trials</p>
                    <div class="kpi-visual" data-kpi="totalTrials" aria-labelledby="totalTrialsLabel">
                        <span class="kpi-fallback-value">{{ kpis.total_trials }}</span>
                    </div>
                    <p class="kpi-subtext">Active across this window</p>
                </div>
                <div class="reporting-kpi-card">
                    <p class="kpi-label text-uppercase text-semibold" id="complianceGaugeLabel">Overall Compliance Rate</p>
                    <div class="kpi-visual kpi-visual--gauge" data-kpi="complianceGauge" role="img"
                        aria-labelledby="complianceGaugeLabel complianceGaugeDesc">
                        <span id="complianceGaugeDesc" class="usa-sr-only">
                            {{ kpis.overall_compliance_rate }} percent compliant to date.
                        </span>
                        <span class="kpi-fallback-value">{{ kpis.overall_compliance_rate }}%</span>
                    </div>
                </div>
                <div class="reporting-kpi-card">
                    <p class="kpi-label text-uppercase text-semibold" id="issueCountLabel">Trials with Issues</p>
                    <div class="kpi-visual" data-kpi="issueCount" aria-labelledby="issueCountLabel">
                        <span class="kpi-fallback-value">{{ kpis.trials_with_issues_count }}</span>
                    </div>
                    <p class="kpi-subtext">{{ kpis.trials_with_issues_pct }}% of total</p>
                </div>
                <div class="reporting-kpi-card">
                    <p class="kpi-label text-uppercase text-semibold" id="avgDelayLabel">Average Reporting Delay</p>
                    <div class="kpi-visual" data-kpi="avgDelay" aria-labelledby="avgDelayLabel">
                        <span class="kpi-fallback-value">{{ kpis.avg_reporting_delay_days }} days</span>
                    </div>
                    <p class="kpi-subtext">Among overdue submissions</p>
                </div>
            </section>
            <div class="usa-card bg-base-lightest shadow-2 margin-bottom-3">
                <div class="usa-card__header">
                    <h1 class="usa-card__heading margin-0">Reporting Overview</h1>
                </div>
                <div class="usa-card__body">
                    <p class="font-sans-md">
                        Track cumulative trial starts over time. Counts are bucketed by the month of each trial's
                        <code>start_date</code> and displayed as a running total.
                    </p>
                    <p class="usa-hint margin-0">
                        Adjust the date range to focus on a specific review window. The chart below reflects the same
                        time frame exposed via the JSON API at <code>/api/reporting/time-series</code>.
                    </p>
                </div>
            </div>

            <div class="usa-card shadow-2">
                <div class="usa-card__header">
                    <h2 class="usa-card__heading margin-0">Compliance status timeline</h2>
                </div>
                <div class="usa-card__body">
                    {% if latest_point %}
                    <div class="grid-row grid-gap margin-bottom-3">
                        <div class="tablet:grid-col-4">
                            <div class="bg-base-lightest padding-2 radius-md">
                                <p class="text-uppercase text-semibold margin-0">Cumulative trials</p>
                                <p class="font-sans-2xl margin-0">{{ latest_point.total_cumulative }}</p>
                                <p class="usa-hint margin-0">Through {{ latest_point.month_label }}</p>
                            </div>
                        </div>
                        <div class="tablet:grid-col-4">
                            <div class="bg-base-lightest padding-2 radius-md">
                                <p class="text-uppercase text-semibold margin-0">New this month</p>
                                <p class="font-sans-2xl margin-0">{{ latest_point.total_monthly }}</p>
                                <p class="usa-hint margin-0">{{ latest_point.month_label }}</p>
                            </div>
                        </div>
                        <div class="tablet:grid-col-4">
                            <div class="bg-base-lightest padding-2 radius-md">
                                <p class="text-uppercase text-semibold margin-0">Months tracked</p>
                                <p class="font-sans-2xl margin-0">{{ time_series|length }}</p>
                                {% if time_series %}
                                <p class="usa-hint margin-0">Since {{ time_series[0].month_label }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="grid-row grid-gap margin-bottom-2">
                        <div class="grid-col-12">
                            <div class="display-flex flex-wrap gap-2">
                                {% for status in status_keys %}
                                {% set status_data = latest_point.statuses[status.key] if latest_point and status.key in
                                latest_point.statuses else None %}
                                <div class="bg-base-lighter padding-2 radius-md margin-right-2 margin-bottom-2"
                                    style="min-width: 12rem;">
                                    <p class="text-uppercase text-semibold margin-0">{{ status.label }}</p>
                                    <p class="font-sans-xl margin-0">
                                        {{ status_data.cumulative if status_data else 0 }}
                                    </p>
                                    <p class="usa-hint margin-0">
                                        +{{ status_data.monthly if status_data else 0 }} in {{ latest_point.month_label
                                        if latest_point else '' }}
                                    </p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div id="reporting-chart" class="reporting-chart" role="img"
                        aria-label="Line chart showing cumulative trial counts over time"></div>
                    <div id="reporting-chart-legend" class="margin-top-2"></div>
                    {% if not time_series %}
                    <p class="usa-hint margin-top-2">No trial starts found for the selected time range.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    window.reportingData = {
        time_series: {{ time_series | tojson }},
        status_keys: {{ status_keys | tojson }},
        kpis: {{ kpis | tojson }}
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="{{ url_for('static', filename='js/reporting.js') }}"></script>
{% endblock content %}
